<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://axelor.com/xml/ns/object-views"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://axelor.com/xml/ns/object-views https://axelor.com/xml/ns/object-views/object-views_8.0.xsd">

  <dashboard name="dasbhoard-wkf-model" title="Workflow dashboard">
    <dashlet action="chart:chart.wkf.model.status.per.month" title="Status per month"
      height="350" colSpan="12"/>
    <dashlet action="chart:chart.wkf.model.status.per.day" title="Status per day"
      height="350" colSpan="12"/>
    <dashlet action="chart:chart.wkf.model.time.spent.per.status"
      title="Time spent per status (hours)" height="350" colSpan="12"/>
  </dashboard>

  <dashboard name="dasbhoard-wkf-instance" title="Wkf instance dashboard">
    <dashlet action="chart:chart.wkf.instance.timespent.per.node" title="Timespent per node"
      height="350" colSpan="12"/>
    <dashlet action="custom:custom.wkf.instance.node.activation.time"
      title="Node activation time" height="350" colSpan="12"/>
  </dashboard>

  <form name="bpm-manager-dashboard-form" model="com.axelor.utils.db.Wizard"
    title="BPM Dashboard" width="large" onNew="action-bpm-manage-attrs-set-process" canSave="false"
    canNew="false">
    <panel name="actionPanel" colSpan="12">
      <button name="$showProcessBtn" colSpan="3" widget="info-button" title="Show Processes"
        onClick="action.bpm.manager.show.processes"/>
    </panel>
    <panel name="dashboardPanel">
      <panel-dashlet title="Assigned to me"
        action="chart:chart.wkf.bpm.manager.assigned.me.tasks" height="400"/>
      <panel-dashlet title="Assigned to others"
        action="chart:chart.wkf.bpm.manager.assigned.other.tasks" height="400"/>
      <panel-dashlet title="Tasks by process"
        action="chart:chart.wkf.bpm.manager.task.by.process" height="450" colSpan="12"/>
      <panel-dashlet title="Average time spent per node by per users"
        action="chart:chart.wkf.bpm.manager.average.time.per.node.by.user" height="450" colSpan="12"/>
      <panel-dashlet title="Task done today per user"
        action="chart:chart.wkf.bpm.manager.task.done.today.per.user" height="400"/>
      <panel-dashlet title="Task to do per user"
        action="chart:chart.wkf.bpm.manager.task.to.do.per.user" height="400"/>
      <panel-dashlet title="Tasks completion by days"
        action="chart:chart.wkf.bpm.manager.task.completion.by.days" height="400" colSpan="12"/>
    </panel>
  </form>

  <form name="bpm-manager-processes-form" title="Processes" model="com.axelor.utils.db.Wizard"
    onNew="action-wkf-bpm-manager-dashboard-method-on-new" width="large" canSave="false"
    canNew="false">
    <panel name="wkfModelPanel">
      <label name="$noData" title="No data to display" showIf="_xTotalRecord == 0"/>
      <field name="$models" colSpan="12" showTitle="false" readonly="true">
        <viewer><![CDATA[
          <>
            {_xModelList?.map((model, modelIndex) => (
              <Table key={modelIndex} style={{borderBottom: "1px solid #bbb"}}>
                <TableHead>
                  <TableRow>
                    <TableCell variant="head" style={{fontSize: "14px"}}>
                      {model.title}{model.versionTag != null ? ' - '+model.versionTag : ''}
                    </TableCell>
                  </TableRow>
                </TableHead>
                <TableBody>
                  {model?.processList?.map((process, processIndex) => (
                    <TableRow key={processIndex}>
                      <TableCell style={{paddingLeft: "20px"}}>
                        <div style={{fontWeight: "bolder", paddingBottom: "8px", borderBottom: "1px solid #ddd", marginBottom:"8px"}}>
                          <span>{process.title}</span>
                        </div>

                        {process?.itemList?.map((item, itemIndex) => (
                          item.type == 'model' && (
                            <div style={{paddingLeft: "20px"}} key={itemIndex}>
                              <p>
                                <Button style={{ fontWeight: "bold"}} ui-action-context="item" onClick={$action('action-wkf-model-method-model-per-view')}>
                                  {_t('value:' + item.title) == 'value:'+item.title ? item.title : _t('value:' + item.title)} ({item.modelRecordCount})
                                </Button>
                              </p>
                              {(model.isSuperAdmin || model.isAdmin || model.isManager || model.isUser) && (
                                <div style={{ padding: "8px", display: "flex", borderTop: "1px solid #ddd"}}>
                                  <div>
                                    <p>Assigned to me</p>
                                    {item.userStatuses.length == 0 && <p style={{marginLeft: "9px", fontStyle: "italic"}}>{_t('No status')}</p>}

                                    {item.userStatuses.length > 0 && (
                                      <p style={{display:"list-item", marginLeft:"25px"}}>
                                        {item.userStatuses?.map((status, statusIndex) => (
                                          <Button key={statusIndex} ui-action-context="status" onClick={$action('action-wkf-model-method-status-per-view')}>
                                            {_t('value:' + status.title) == 'value:'+status.title ? status.title : _t('value:' + status.title)} ({status.statusCount})
                                          </Button>
                                        ))}
                                      </p>
                                    )}
                                  </div>
                                </div>
                              )}
                              {(model.isSuperAdmin || model.isAdmin || model.isManager) && (
                                <div style={{ padding: "8px", display: "flex", borderTop: "1px solid #ddd"}}>
                                  <div>
                                    <p>Assigned to others</p>
                                    {item.userStatuses.length == 0 && <p style={{marginLeft: "9px", fontStyle: "italic"}}>{_t('No status')}</p>}

                                    {item.userStatuses.length > 0 && (
                                      <p style={{display:"list-item", marginLeft:"25px"}}>
                                        {item.userStatuses?.map((status, statusIndex) => (
                                          <Button key={statusIndex} ui-action-context="status" onClick={$action('action-wkf-model-method-status-per-view')}>
                                            {_t('value:' + status.title) == 'value:'+status.title ? status.title : _t('value:' + status.title)} ({status.statusCount})
                                          </Button>
                                        ))}
                                      </p>
                                    )}
                                  </div>
                                </div>
                              )}
                            </div>
                          )
                        ))}
                      </TableCell>
                    </TableRow>
                  ))}
                </TableBody>
              </Table>
            ))}
          </>
        ]]></viewer>
      </field>
      <button name="previousBtn" title="&lt;&lt; Previous"
        onClick="action-wkf-bpm-manager-dashboard-method-pre-manager-data" colSpan="2"
        hideIf="_xOffset == 0"/>
      <spacer colSpan="8"/>
      <button name="nextBtn" title="Next &gt;&gt;"
        onClick="action-wkf-bpm-manager-dashboard-method-nxt-manager-data" colSpan="2"
        hideIf="_xOffset + _xLimit &gt;= _xTotalRecord"/>
      <field name="_xLimit" type="integer" hidden="true" x-dirty="false"/>
      <field name="_xOffset" type="integer" hidden="true" x-dirty="false"/>
      <field name="_xTotalRecord" type="long" hidden="true" x-dirty="false"/>
    </panel>
  </form>

  <action-method name="action-wkf-bpm-manager-dashboard-method-on-new">
    <call class="com.axelor.studio.bpm.web.BpmManagerDashboardController"
      method="showBpmManagerProcess"/>
  </action-method>

  <action-method name="action-wkf-bpm-manager-dashboard-method-pre-manager-data">
    <call class="com.axelor.studio.bpm.web.BpmManagerDashboardController"
      method="showPreviousProcess"/>
  </action-method>

  <action-method name="action-wkf-bpm-manager-dashboard-method-nxt-manager-data">
    <call class="com.axelor.studio.bpm.web.BpmManagerDashboardController"
      method="showNextProcess"/>
  </action-method>

  <action-view name="action.bpm.manager.show.processes" title="Processes"
    model="com.axelor.utils.db.Wizard">
    <view type="form" name="bpm-manager-processes-form"/>
  </action-view>

  <action-record name="action-bpm-manage-attrs-set-process"
    model="com.axelor.utils.db.Wizard">
    <field name="$showProcessBtn"
      expr="eval: __repo__(WkfModel).all().filter('size(self.wkfProcessList) > 0').count()"/>
  </action-record>

</object-views>
